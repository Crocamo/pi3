<div class="container mt-1">
    <h2>{{title}}</h2>
    {{status}}

    <form method="post">
        <div class="cliente-infos">

            <!-- Div para selecionar cliente -->
            {{itens}}

            <!-- Lista de serviços adicionados -->
            <div class="row">
                <div id="lista-servicos" class="form-group"></div>
            </div>
            <div class="row">
                <!-- Campo para desconto ou acréscimo -->
                <div class="col">
                    <label for="desconto-acrescimo">Desconto/Acréscimo:</label>
                    <input type="text" class="form-control" id="desconto-acrescimo" name="desconto-acrescimo">
                </div>

                <div class="col">
                    <label for="desconto">Desconto:</label>
                    <input type="checkbox" class="form-control" id="desconto" name="desconto" value="desconto" checked>
                </div>

                <div class="col">
                    <label for="porcentagem">porcentagem:</label>
                    <input type="checkbox" class="form-control" id="porcentagem" name="porcentagem">
                </div>

            </div>

            <!-- Campo para Confirmar ou voltar -->
            <div class="form-group">
                <button type="submit" class="btn btn-success mt-2 mr-2">Concluir
                    Orçamento</button>
            </div>
        </div>
    </form>
</div>

<!-- Seu HTML existente -->

<!-- Inclua seus scripts JavaScript aqui -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    // Seleciona os elementos dos checkboxes
    const descontoCheckbox = document.getElementById('desconto');


    // Função para validar o valor do campo desconto-acrescimo quando a opção de porcentagem está ativada
    function validarPorcentagemInput(event) {
        var valorDigitado = event.target.value;
        var valorNumero = parseInt(valorDigitado);

        // Verifica se o valor digitado é um número válido entre 1 e 100
        if (isNaN(valorNumero) || valorNumero <= 0) {
            event.target.value = 0; // Limpa o campo se o valor não for válido
        } else if (valorNumero > 100) {
            event.target.value = 100;
        }
    }

    // Função para formatar o valor do campo desconto-acrescimo com incremento de milhares e vírgula após os dois primeiros dígitos
    function validarMonetarioInput(event) {
        var valorDigitado = event.target.value;

        // Remove todos os caracteres não numéricos
        var valorAlterado = valorDigitado.replace(/[^\d]/g, '');

        valorAlterado = valorAlterado.replace(/(\d+)(\d{2})$/, "$1,$2");
        valorAlterado = valorAlterado.replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1.");
        // Atualiza o valor do campo
        event.target.value = valorAlterado;
    }

    // Espera até que o documento esteja completamente carregado
    document.addEventListener("DOMContentLoaded", function () {
        // Seleciona o campo porcentagem
        var porcentagemCheckbox = document.getElementById("porcentagem");
        // Seleciona o campo desconto-acrescimo
        var descontoAcrescimoInput = document.getElementById("desconto-acrescimo");

        // Define um exemplo de valor e placeholder para o campo desconto-acrescimo
        descontoAcrescimoInput.value = '';
        descontoAcrescimoInput.placeholder = '1.000,00'; // Placeholder para valores de 1 a 100

        // Adiciona um evento de entrada ao campo desconto-acrescimo
        descontoAcrescimoInput.addEventListener("input", function (event) {
            // Verifica se a opção de porcentagem está ativada
            if (porcentagemCheckbox.checked) {
                validarPorcentagemInput(event); // Valida o valor do campo se a porcentagem estiver ativada
            } else {
                validarMonetarioInput(event);
            }
        });

        // Adiciona um evento de mudança ao campo porcentagem
        porcentagemCheckbox.addEventListener("change", function () {
            if (porcentagemCheckbox.checked) {
                // Se porcentagem estiver marcado, redefine o valor e o placeholder
                descontoAcrescimoInput.value = ''; // Limpa o campo
                descontoAcrescimoInput.placeholder = '1 a 100'; // Placeholder para valores de 1 a 100
            } else {
                // Se porcentagem não estiver marcado, redefine o valor e o placeholder
                descontoAcrescimoInput.value = '';
                descontoAcrescimoInput.placeholder = 'R$ 1.000,00'; // Placeholder monetário
            }
        });
    });

    // Função para formatar telefone/celular
    function formatarTelCel(input) {
        var cleaned = input.value.replace(/\D/g, '');
        var length = cleaned.length;

        if (length <= 8) {
            input.value = cleaned.replace(/(\d{4})(\d{4})/, '$1-$2');
        } else if (length == 9) {
            input.value = cleaned.replace(/(\d{1})(\d{4})(\d{4})/, '$1 $2-$3');
        } else if (length == 10) {
            input.value = cleaned.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
        } else if (length == 11) {
            input.value = cleaned.replace(/(\d{2})(\d{1})(\d{4})(\d{4})/, '($1) $2 $3-$4');
        } else if (length == 12) {
            input.value = cleaned.replace(/(\d{2})(\d{2})(\d{4})(\d{4})/, '+$1 ($2) $3-$4');
        } else {
            input.value = cleaned.replace(/(\d{2})(\d{2})(\d{1})(\d{4})(\d{4})/, '+$1 ($2) $3 $4-$5');
        }
    }

    // Função para formatar CEP
    function formatarCEP(input) {
        var cleaned = input.value.replace(/\D/g, '');
        input.value = cleaned.replace(/(\d{5})(\d{3})/, '$1-$2');
    }
    var count = 0; // Inicializando a variável count

    $(document).ready(function () {
        $('#selectCliente').change(function () {
            var selectedOption = $(this).find('option:selected').val();
            var clienteData = selectedOption.split('//');
            $('#nome_cli').val(clienteData[1]);
            $('#endereco').val(clienteData[2]);
            $('#estado').val(clienteData[3]);
            $('#cidade').val(clienteData[4]);
            $('#cep').val(clienteData[5]);
            $('#telefone').val(clienteData[6]);
        });

        // Adiciona o manipulador de evento para os botões "Excluir"
        $(document).on("click", ".btn-excluir", function () {
            $(this).closest(".servico-adicionado").remove(); // Remove o serviço pai do botão "Excluir"
            count--; // Diminui o count ao excluir um serviço
        });

        var btnAdicionar = document.querySelector(".btn-primary");

        btnAdicionar.addEventListener("click", function () {
            var selectServico = document.querySelector("#selectServico");
            var selectedOption = selectServico.options[selectServico.selectedIndex];
            var selectedValue = selectedOption.value;

            if (selectedValue) {
                var details = selectedValue.split("//");

                var novoServico = document.createElement("div");
                novoServico.classList.add("servico-adicionado");

                novoServico.innerHTML = `
            <div style="display: flex; align-items: center;">
                <label for="servico" style="margin-right: 10px;">Serviço:</label>
                <input type="text" id="servico${count}" name="servico${count}" readonly value="${details[1]}" style="width: 150px; margin-right: 10px;">  
                <label for="tipo" style="margin-right: 10px;">Tipo:</label>
                <input type="text" id="tipo${count}" name="tipo${count}" readonly value="${details[2]}" style="width: 120px; margin-right: 10px;">
                <label for="area" style="margin-right: 10px;">Área:</label> 
                <input type="text" id="area${count}" name="area${count}" readonly value="${details[3]}" style="width: 100px; margin-right: 10px;">
                <label for="preco" style="margin-right: 10px;">Preço:</label> 
                <input type="text" id="preco${count}" name="preco${count}" readonly value="R$ ${details[4]}" style="width: 100px; margin-right: 10px;">
            </div>
            <div style="display: flex; align-items: center;">
                <label for="qtd_servico" style="margin-right: 10px;">Quantidade:</label> 
                <input type="text" id="qtd_servico${count}" name="qtd_servico${count}" value="1" style="width: 80px; margin-right: 10px;">
                <p style="margin-right: 10px;"><strong>Total:R$</strong><span id="total_servico" style="width: 150px;">${details[4]}</span></p>
                <label for="obs" style="margin-right: 10px;">Observação:</label> 
                <input type="text" id="obs${count}" name="obs${count}" style="width: 150px; margin-right: 10px;">
                <button type="button" class="btn btn-danger btn-excluir" data-toggle="modal" data-target="#excluirServicoModal" style="margin-right: 10px;">Excluir</button>
                <input type="hidden" id="id${count}" name="id${count}" readonly value="${details[0]}" style="width: 50px; margin-right: 10px;">
            </div>
        `;

                var listaServicos = document.querySelector("#lista-servicos");

                listaServicos.appendChild(novoServico);

                // Seleciona o campo de entrada da quantidade de serviço
                var qtdServicoInput = novoServico.querySelector(`#qtd_servico${count}`);

                // Adiciona um evento de entrada para calcular o total quando a quantidade é inserida
                qtdServicoInput.addEventListener("input", function () {
                    // Obtém o valor da quantidade inserida
                    var qtd = parseInt(qtdServicoInput.value);
                    // Calcula o total multiplicando o preço pelo quantidade
                    var total = parseFloat(details[4]) * qtd;

                    // Seleciona o elemento onde o total será exibido
                    var totalServicoSpan = novoServico.querySelector("#total_servico");

                    // Exibe o total
                    totalServicoSpan.textContent = total.toFixed(2);
                });

                count++; // Incrementa o count após adicionar um novo serviço
            }
        });
    });
</script>